# 投資決策輔助系統 — 產品需求規格

本文件定義投資決策輔助系統的完整規格。系統的核心定位是成為投資者的「認知義肢」——將有限的工作記憶和容易受情緒影響的判斷過程，外化為可靠的工具系統。

---

## 設計哲學：認知共振工程

投資決策的失敗，往往不是邏輯錯誤，而是認知超載。本系統不是交易機器人，而是一套分佈式認知架構，將複雜的市場判斷系統化地分解為可管理的認知任務。

### 設計原則

系統設計遵循五項核心原則。

**SRK 對齊**基於 Rasmussen 的技能-規則-知識認知模型，將 CLI 指令設計為不同認知層次：常用的日常操作對應技能層次（幾乎自動化），例外處理對應規則層次（條件判斷），深度除錯對應知識層次（原理理解）。

**認知卸載**利用 Miller 7±2 的工作記憶容量理論，將 VIX 判斷、體制識別等複雜運算交給系統自動計算，讓使用者只需查看簡化的燈號。

**雙重監控**結合 Zimmerman 和 Pintrich 的自我調節學習理論，同時維護客觀的行為記錄和主觀的信心校準，避免過度自信偏誤。

**執行鴻溝橋接**依據 Norman 的互動模型，提供清晰的指意設計和具有建設性的錯誤訊息，幫助使用者快速找到正確操作。

**漸進式揭露**遵循認知負荷理論，資訊呈現從概覽到細節：先看 DEFCON 燈號，再看體制數字，最後才是原始指標。

### 三層決策優先級

所有決策遵循三層否決權架構。生存層是最高優先級，由 VIX、GLI 和 VPIN 構成，具有絕對否決權，整合於每日簡報的環境評估區塊。戰略層由事件驅動訊號和 HMM 體制判斷構成，用於決定整體方向，整合於日報和週報。戰術層包含 Hurst 指數和 GEX，用於決定具體的進出時機，整合於掃描和監控功能。

---

## 決策循環架構

系統採用整合 OODA 循環與 SRL 自我調節學習模型的雙層循環架構。

### 宏觀循環

宏觀層面的循環分為三個階段。前瞻階段負責環境評估和策略預選，回答「現在安全嗎」和「應該用什麼策略」的問題。表現階段執行篩選和持倉監控，回答「如何執行」和「如何監控」的問題。反思階段進行績效驗證和雙環學習，回答「績效是技能還是運氣」的問題。

### CLI 指令體系

系統提供主要的 CLI 指令，分為完整流程和分離執行兩種模式。

#### 完整流程

**make scan** 執行全市場殘差動能掃描（含動能評估與財報狗爬蟲），結果輸出至 JSON，用於生成候選股清單。

**make retain** 對單一標的進行完整動能驗證（含動能評估與財報狗），結果輸出至控制台，用於快速確認特定股票。

#### 分離執行（進度條更準確）

**make scan-momentum** 只執行動能評估階段（Phase 1），不含財報狗爬蟲。

**make scan-fundamental** 只執行財報狗爬蟲階段（Phase 2），讀取已有 JSON 並補上財報狗資料。

**make retain-momentum** 對單一標的只執行動能評估。

**make retain-fundamental** 對單一標的只執行財報狗爬蟲（需先有 JSON）。

#### 報表與監控

**make summary** 取得指定日期的全部掃描資料，從 JSON 匯出 CSV（需同時有動能和財報狗資料）。

**make stock** 取得指定日期的單一股票資料，用於個股追蹤。

**make daily** 生成每日簡報，整合 DEFCON 天候、體制判定、事件日曆、掃描結果和部位建議等多項分析。

**make weekly** 生成週報，專注於績效驗證、技能判定和策略健康度評估。

**make sync-data** 同步外部資料，包括經濟日曆和股票池更新。

### 功能整合設計決策

本專案刻意採用整合式架構，將多項分析功能整合至電子報，而非提供大量獨立 CLI 指令。這個設計基於三項考量：減少使用者需記憶的指令數量以最小化認知負荷；將分析結果在決策時點統一呈現以對齊工作流程；電子報整合確保所有分析基於相同時間點的數據以維持資料一致性。

具體而言，個股健檢整合於日報中從 Sheets 讀取當日掃描結果進行診斷；三層體制識別作為日報和週報環境評估的一部分；供應鏈傳導是日報「昨夜美股」區塊的核心；部位規模建議在掃描結果旁顯示；擁擠度監控納入週報的週度反思；統計驗證是週報「技能 vs 運氣」的核心；GLI 流動性是日報環境評估的一部分；殘差動能定價的理論價格和半衰期在掃描結果中呈現。

---

## 前瞻階段：環境評估與策略預選

### DEFCON 天候系統

DEFCON 系統將複雜的市場狀態壓縮為單一燈號，實現最大化的認知卸載。

DEFCON 5 是綠燈狀態，當 VIX 低於 20 且 HMM 處於狀態 0 或 1 時觸發，系統處於全自動模式，允許正常交易。

DEFCON 4 是黃燈狀態，當 VIX 超過 20 或 HMM 進入狀態 2 時觸發，仍維持全自動但禁止加碼，僅允許減倉。

DEFCON 3 是橙燈狀態，當 VIX 超過 30 或 TDA 觸發時啟動限制模式，部位必須控制在 50% 以下，停止開新倉。

DEFCON 2 是紅燈狀態，當 VIX 超過 40、出現負 GEX 或 VPIN 超過 0.95 時進入防禦模式，必須清空所有 Alpha 部位，僅保留現金和避險資產。

DEFCON 1 是黑燈狀態，當 VIX 超過 50 或發生熔斷時觸發人工接管，啟動 Kill Switch 將資產撤至全現金或美債。

各指標的燈號對應如下。VIX 方面，低於 20 為綠燈，20 到 25 為黃燈，25 到 35 為橙燈，超過 35 為黑燈。VPIN 方面，低於 0.7 為綠燈，0.7 到 0.9 為黃燈，超過 0.9 為橙燈，超過 0.95 為黑燈。GEX 方面，正值為綠燈，接近翻轉點為黃燈，負值為橙燈，發生 Flip 為黑燈。GLI Z-Score 方面，正值為綠燈，0 到 -1 為黃燈，-1 到 -1.5 為橙燈，低於 -1.5 為黑燈。

### 三層體制識別

體制識別系統將多維度的市場狀態融合為單一「體制標籤」，供規則層次決策使用。

第一層使用 Hurst 指數進行快速判斷，每日更新。當 Hurst 大於 0.55 時市場呈現趨勢特性，低於 0.45 時傾向均值回歸。

第二層使用隱藏馬可夫模型進行更精細的分析，每週更新，輸出各狀態的機率值。

第三層使用 PCA 餘弦相似度檢測市場結構穩定度，同樣每週更新，當相似度低於 0.8 時發出結構斷裂警示。

### HMM 體制權重配方

不同市場體制對應不同的因子權重配方。

在平靜牛市（VIX 低且穩定、趨勢向上）時，配置 60% 權重於動能因子、20% 於價值因子、20% 於品質因子，戰略重點是追逐殘差動能與產業動能。

在高波震盪（VIX 升高、無明確方向）時，動能權重降至 30%、價值權重提升至 40%、品質維持 30%，戰略重點轉向尋找高 F-Score 搭配高 IVOL 的錯殺股。

在恐慌熊市（VIX 飆升、視界崩塌）時，完全停止進場操作，將資金轉為全現金或債券。HMM 的核心優勢是「逃頂」而非抄底。

### 矛盾決策處理

當多個訊號源產生矛盾時，系統提供明確的決策矩陣。

價值陷阱情境發生在本益比低但應計項目高時，應採納 Sonnet 建議避開。動能過熱情境發生在動能極高但收盤價遠超理論價格時，應採納 Gemini 建議減碼或設停損。錯殺機會情境發生在動能低但 Alpha 高且 F-Score 達到 7 分以上時，應採納 Opus 建議進行左側佈局。訊號背離情境發生在價格創新高但訊號顯示賣出時，應採納 Grok 建議獲利了結。擁擠交易情境發生在成交量和 IVOL 同時飆高時，應採納 Thinking 建議觀望或減碼。營運拐點情境發生在動能弱但營收月增年增加速時，應採納 ChatGPT 建議觀察進場。

### 事件日曆

事件日曆將時間軸上的風險點外化為可執行的行動劇本。

系統支援的事件類型包括：FOMC 聯準會會議（高風險，尤其是含有 SEP 點陣圖的場次）、台灣央行理監事會議（中風險）、MSCI 季度和半年度調整（高風險）、高股息 ETF 換股如 00878 和 00919 等（低風險）、台指期結算日每月第三週三（中風險）、SEC 13F 報告截止（低風險）、台積電法說會（中風險）、以及 Apple 發表會（中風險）。

對於不同事件類型有對應的進退場時機。MSCI 調整的最佳進場時機是公告後一週，退場時機是生效日尾盤。四巫日應在結算週週一進場，結算日收盤時退場。ETF 換股如 00919 應在四月股利政策公告後進場，五月換股生效日退場。台指期結算日應在 13:00 到 13:30 避免交易。FOMC 和非農就業報告日則應降低槓桿。

### 跨市連結分析

跨市連結分析將跨市場的資訊差和時區延遲轉化為可操作的訊號。具體流程是先抓取美股 T-1 日收盤資料，再抓取台股 T 日開盤資料，計算預期傳導等於 Beta 乘以美股報酬，識別滯後等於預期減去實際，最後透過 Kalman 濾波更新動態 Beta。這個分析整合於日報的「昨夜美股」區塊。

---

## 表現階段：策略執行與監控

### 殘差動能掃描

殘差動能掃描自動化品質濾網，將「篩選判斷」卸載給系統。執行 `make scan` 進行全市場掃描結果輸出至 Google Sheets，執行 `make retain SYMBOL=2330` 對單一標的進行動能驗證結果輸出至控制台。

掃描流程分為十個步驟。第一步抓取價格資料。第二步進行 PCA 因子剝離。第三步計算動能分數。第四步應用 IVOL 與 F-Score 交叉矩陣進行判定。第五步設置 MAX 濾網剔除單日漲幅超過 15% 的標的。第六步設置 ID（FIP）濾網剔除 ID 大於 0 的跳躍型動能。第七步設置 Amihud 濾網剔除最高 20% 的低流動性標的。第八步進行隔夜確認剔除隔夜報酬小於等於零的標的。第九步進行 EEMD 趨勢確認要求斜率大於零且維持三天以上。第十步執行板塊限額確保單一板塊不超過 30% 且相關性超過 0.8 時剔除低分者。

### IVOL 與 F-Score 決策矩陣

高波動不僅是風險，更是錯殺機會。IVOL 超過第 80 百分位定義為高波動，第 50 到 80 百分位為中波動，低於第 50 百分位為低波動。

對於高 IVOL 標的：F-Score 達到 7 分以上視為錯殺機會應積極買入，F-Score 5 到 6 分列入觀察，F-Score 4 分以下視為彩票股應剔除。

對於中 IVOL 標的：F-Score 5 分以上為標準候選，F-Score 4 分以下應剔除。

對於低 IVOL 標的：F-Score 5 分以上可作為防禦型持股，F-Score 4 分以下同樣應剔除。

此外還需進行價值陷阱過濾，本益比低於第 5 百分位且應計項目比率高者應剔除，避免落入「便宜但財務惡化」的陷阱。

### 部位規模計算

部位規模計算將凱利公式與 HRP 階層配置工程化為可執行的數字，整合於日報掃描結果表格的建議部位欄位。

最終部位等於體制係數乘以 VIX 係數再乘以凱利公式結果。體制係數來自 Hurst 和 HMM 判斷，範圍從 0.0 到 0.5。VIX 係數來自 VIX 燈號，範圍從 0.0 到 1.0。無論計算結果如何，單一標的上限硬性規定不得超過 10%。

HRP 階層式風險平價取代傳統的波動率倒數加權。它首先將候選股依價格行為自動分群（如科技群、傳產群），然後先分配資金給群組，再分配給個別股票，這樣可以避免資金過度集中於高相關資產。

### 個股健檢

個股健檢整合多維度分析為單一 PASS 或 WARNING 判定，從 Google Sheets 讀取當日掃描結果後執行診斷並編入日報。

檢查維度包括：殘差趨勢檢查 EEMD 斜率是否大於零且維持三天以上；品質濾網確認 IVOL、ID、Amihud 是否全部通過；隔夜確認檢查隔夜與日內報酬比例是否大於 0.5 顯示機構主導；相關性漂移檢查與大盤的 20 日相關係數是否低於 0.7 顯示 Alpha 尚存。

### 持倉監控迴路

日常監控遵循 OODA 循環的固定時程。

08:00 檢查美股隔夜走勢和 GLI 指標，若 GLI Z-Score 低於 -1.5 則減倉。

08:15 查看 VIX 和 GEX 天候，若 VIX 超過 25 則禁止開新倉。

13:30 監測 VPIN 毒性，若超過 0.9 則暫停逆勢單。

14:00 檢查相關性漂移，若與大盤相關係數超過 0.7 則發出 Alpha 消失警報。

### 3D 立體出場機制

出場機制建立「交易隧道」從三個維度保護部位。

**地板層**保護下檔風險，設有硬停損線成本價減去 10% 作為絕對止損，以及波動停損當 IVOL 飆升至前 5% 且 F-Score 同時下滑時觸發。

**斜坡層**保護利潤，使用 ATR 移動停損，止損點等於最高價減去兩倍 ATR。

**牆壁層**考量機會成本，設有時間止損持有 10 日後若 Alpha 仍小於等於零則強制平倉，以及 RSI 背離當價格創新高但殘差 RSI 未創新高時視為獲利了結時機。

---

## 反思階段：驗證與學習

### 策略統計驗證

統計驗證對抗「過度自信」偏誤，提供客觀的績效校準，整合於週報的「技能 vs 運氣」區塊。

DSR（Deflated Sharpe Ratio）是平減夏普比率，通過條件為 DSR 大於 0.95。WFO（Walk-Forward Optimization）進行滾動樣本外測試，通過條件為權益曲線連續向上。CPCV（Combinatorial Purged Cross-Validation）消除數據洩漏，通過條件為夏普分布平均值大於 1.0。FDR 控制多重測試的偽陽性，通過條件為通過 BH 調整。PBO（Probability of Backtest Overfitting）評估過擬合概率，通過條件為低於 30%。

### 雙環學習

雙環學習機制區分「調參」與「改假設」，對應 SRL 的單環和雙環學習，整合於週報的「結構性調整」區塊。

單環學習在樣本外表現略差時觸發，動作是調整參數如時間窗口和閾值，不改變底層假設。

雙環學習在偵測到結構性斷裂時觸發，動作是質疑底層假設並重構模型，這是根本性的方法論修正。

### 擁擠度監控

擁擠度監控預警 Alpha 衰減，觸發「紅皇后效應」警報，整合於週報的「策略健康度」區塊。

當成對相關性超過 0.8 時應減倉因子曝險。當 Days-to-Cover 超過 10 天時發出流動性危機預警。當 DSR 低於 0.95 時發出策略退役警示。當 Alpha 半衰期短於執行延遲時應取消交易。

---

## 電子報產品

每份報告回答一個核心問題，對應一個 SRL 階段。

**日報盤前簡報**每日 08:30 發送，回答「今天安全嗎」的問題，對應前瞻階段。

**週報體檢**每週日 20:00 發送，回答「績效是技能還是運氣」的問題，對應反思階段。

**風險警報**事件驅動發送，回答「現在需要行動嗎」的問題，對應監控階段。

### 日報結構

日報由六個區塊組成。DEFCON 狀態區塊整合 VIX、GLI 和 VPIN 天候燈號，讓使用者在 2 秒內做出決策。昨夜美股區塊透過 Kalman Beta 進行跨市傳導分析，預測今日台股反應。體制判定區塊融合 HMM、Hurst 和 PCA 三層分析，提供策略模式建議。今日事件區塊列出事件日曆和行動劇本作為風控提醒。掃描結果健檢區塊從 Sheets 讀取數據並進行個股診斷，判定標的品質。部位建議區塊整合凱利係數和理論價格，提供部位規模建議。

### 警報觸發條件

VIX 超過 25 時禁止開新倉。VIX 超過 35 時緊急減倉至 20%。VPIN 超過 0.9 時暫停均值回歸策略。GEX 發生 Flip 時切換策略模式。GLI Z-Score 低於 -1.5 時強制降低曝險上限。

---

## 作息與儀式

根據生理能量節律分配認知任務。

### 每日作息

08:00 是判斷力最佳時段，進行環境評估，查看日報 DEFCON 區塊。08:30 接收自動發送的日報，認知負荷低。09:00 開啟即時監控 TUI，認知負荷中。13:30 進行機械式檢查，查看掃描結果，認知負荷低。14:00 進行體制更新，查看日報體制區塊，認知負荷中。

### 每週作息

週五 15:00 執行全市場掃描。週六進行候選股深度分析。週日 10:00 檢查下週事件。週日 20:00 發送週報體檢。

### HALT 檢查

交易前必須自問：是否飢餓（Hungry）？是否憤怒（Angry）？是否孤獨（Lonely）？是否疲憊（Tired）？若任一項為真，應暫停交易，先恢復生理狀態。

---

## 快速決策速查

VIX 低於 20 且 Hurst 大於 0.55 時執行殘差動能策略配合半凱利。VIX 低於 20 且 Hurst 小於 0.45 時執行統計套利配合四分之一凱利。VIX 在 20 到 25 之間禁止開新倉，僅管理現有部位。VIX 超過 25 時減倉至 20%，啟動尾部對沖。事件日前一週採用事件驅動策略，情境凱利。GLI Z-Score 低於 -1.5 時強制降曝險，下修估值倍數 25%。TDA L1 Z-Score 超過 2 時強制降槓桿至 50%。VPIN 超過 0.9 且持續 30 分鐘時暫停逆勢單。

---

## 七層決策檢查清單

第零層檢查 HALT 心情狀態，未通過則暫停交易並調整狀態。第一層確認財務安全，未通過則補足緊急準備金且勿加槓桿。第二層評估 VIX 環境，VIX 超過 25 為黃燈，超過 35 為紅燈。第三層檢視日曆事件，四巫日或 FOMC 前一週應謹慎。第四層確認選股品質，要求 ROIC 大於 WACC 且 F-Score 至少 5 分（高品質要求 7 分以上）。第五層執行配置規模檢查，使用 HRP 加凱利調整，單一標的不超過 10%，板塊不超過 30%。第六層進行持有監控，遵循 3D 出場機制包括硬停損、ATR 移動停損和時間止損。

---

## 品質濾網公式

IVOL 濾網計算特異波動率，剔除前 20% 高波動標的（除非 F-Score 達標）。ID 濾網計算 sign(PRET) 乘以負向日數比例減正向日數比例，剔除 ID 大於 0 的跳躍型動能。Amihud 濾網計算報酬絕對值除以成交量，剔除前 20% 低流動性標的。MAX 濾網檢查月內最大單日漲幅，剔除超過 15% 的標的。

---

> **注意**：未實作項目已移至 `.context/plan.md` 追蹤
